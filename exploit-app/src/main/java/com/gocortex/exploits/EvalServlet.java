// SPDX-FileCopyrightText: GoCortexIO
// SPDX-License-Identifier: AGPL-3.0-or-later

package com.gocortex.exploits;

import javax.script.ScriptEngine;
import javax.script.ScriptEngineManager;
import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.util.ResourceBundle;

@WebServlet("/eval")
public class EvalServlet extends HttpServlet {
    private static final ResourceBundle locale = ResourceBundle.getBundle("servlet-locale");
    
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        
        String code = request.getParameter("code");
        String engine = request.getParameter("engine");
        
        if (engine == null || engine.isEmpty()) {
            engine = "JavaScript";
        }
        
        response.setContentType("text/html");
        response.getWriter().println("<html><body>");
        response.getWriter().println("<h1>" + locale.getString("eval.page_title") + "</h1>");
        response.getWriter().println("<p style='color:#666;'><strong>" + locale.getString("common.version_label") + "</strong> | " + locale.getString("common.vulnerability_tag") + "</p>");
        response.getWriter().println("<form method='get'>");
        response.getWriter().println("<p>" + locale.getString("eval.engine_label") + " ");
        response.getWriter().println("<select name='engine'>");
        response.getWriter().println("<option value='JavaScript'>" + locale.getString("eval.engine_javascript") + "</option>");
        response.getWriter().println("<option value='Groovy'>" + locale.getString("eval.engine_groovy") + "</option>");
        response.getWriter().println("</select></p>");
        response.getWriter().println("<p>" + locale.getString("eval.code_label") + "<br/>");
        response.getWriter().println("<textarea name='code' rows='10' cols='80' placeholder='" + locale.getString("eval.code_placeholder") + "'>" + (code != null ? code : "") + "</textarea>");
        response.getWriter().println("</p>");
        response.getWriter().println("<input type='submit' value='" + locale.getString("eval.submit_button") + "' />");
        response.getWriter().println("</form>");
        response.getWriter().println("<p>" + locale.getString("eval.example_text") + " <code>" + locale.getString("eval.example_code") + "</code></p>");
        
        if (code != null && !code.isEmpty()) {
            try {
                // VULNERABLE: ScriptEngine evaluates user-supplied code
                // VULNERABLE: No sandboxing or security restrictions
                ScriptEngineManager manager = new ScriptEngineManager();
                ScriptEngine scriptEngine = manager.getEngineByName(engine);
                
                if (scriptEngine == null) {
                    response.getWriter().println("<p>" + locale.getString("eval.engine_not_found").replace("{engine}", engine) + "</p>");
                } else {
                    Object result = scriptEngine.eval(code);
                    
                    response.getWriter().println("<h2>" + locale.getString("eval.result_header") + "</h2>");
                    response.getWriter().println("<pre>");
                    response.getWriter().println(locale.getString("eval.engine_executed_label") + " " + engine);
                    response.getWriter().println(locale.getString("eval.success_message"));
                    response.getWriter().println(locale.getString("eval.return_value_label") + " " + result);
                    response.getWriter().println("</pre>");
                }
                
            } catch (Exception e) {
                response.getWriter().println("<p>" + locale.getString("eval.error_message") + " " + e.getMessage() + "</p>");
                response.getWriter().println("<pre>");
                e.printStackTrace(response.getWriter());
                response.getWriter().println("</pre>");
            }
        }
        
        response.getWriter().println("</body></html>");
    }
}
