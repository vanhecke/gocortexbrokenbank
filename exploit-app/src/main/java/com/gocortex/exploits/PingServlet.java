// SPDX-FileCopyrightText: GoCortexIO
// SPDX-License-Identifier: AGPL-3.0-or-later

package com.gocortex.exploits;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.ResourceBundle;

@WebServlet("/ping")
public class PingServlet extends HttpServlet {
    private static final ResourceBundle locale = ResourceBundle.getBundle("servlet-locale");
    
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        
        String target = request.getParameter("target");
        response.setContentType("text/html");
        
        response.getWriter().println("<html><body>");
        response.getWriter().println("<h1>" + locale.getString("ping.page_title") + "</h1>");
        response.getWriter().println("<p style='color:#666;'><strong>" + locale.getString("common.version_label") + "</strong> | " + locale.getString("common.vulnerability_tag") + "</p>");
        response.getWriter().println("<form method='get'>");
        response.getWriter().println("<input type='text' name='target' placeholder='" + locale.getString("ping.input_placeholder") + "' size='50' />");
        response.getWriter().println("<input type='submit' value='" + locale.getString("ping.submit_button") + "' />");
        response.getWriter().println("</form>");
        response.getWriter().println("<p>" + locale.getString("ping.example_text") + " <code>" + locale.getString("ping.example_targets") + "</code></p>");
        
        if (target != null && !target.isEmpty()) {
            try {
                // VULNERABLE: ProcessBuilder with user input concatenated into command
                // VULNERABLE: Allows command injection via semicolons, pipes, etc.
                ProcessBuilder pb = new ProcessBuilder("sh", "-c", "ping -c 4 " + target);
                Process process = pb.start();
                
                BufferedReader reader = new BufferedReader(
                    new InputStreamReader(process.getInputStream()));
                BufferedReader errorReader = new BufferedReader(
                    new InputStreamReader(process.getErrorStream()));
                
                response.getWriter().println("<h2>" + locale.getString("ping.results_header") + "</h2>");
                response.getWriter().println("<pre>");
                
                String line;
                while ((line = reader.readLine()) != null) {
                    response.getWriter().println(line);
                }
                
                while ((line = errorReader.readLine()) != null) {
                    response.getWriter().println(locale.getString("common.error_prefix") + " " + line);
                }
                
                response.getWriter().println("</pre>");
                response.getWriter().println("<p>" + locale.getString("common.exit_code_label") + " " + process.waitFor() + "</p>");
                
            } catch (Exception e) {
                response.getWriter().println("<p>" + locale.getString("ping.error_message") + " " + e.getMessage() + "</p>");
            }
        }
        
        response.getWriter().println("</body></html>");
    }
}
