// SPDX-FileCopyrightText: GoCortexIO
// SPDX-License-Identifier: AGPL-3.0-or-later

package com.gocortex.exploits;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.IOException;
import java.lang.reflect.Method;
import java.net.URL;
import java.net.URLClassLoader;
import java.util.ResourceBundle;

@WebServlet("/dynamic")
public class DynamicServlet extends HttpServlet {
    private static final ResourceBundle locale = ResourceBundle.getBundle("servlet-locale");
    
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        
        String classUrl = request.getParameter("url");
        String className = request.getParameter("class");
        String methodName = request.getParameter("method");
        
        response.setContentType("text/html");
        response.getWriter().println("<html><body>");
        response.getWriter().println("<h1>" + locale.getString("dynamic.page_title") + "</h1>");
        response.getWriter().println("<p style='color:#666;'><strong>" + locale.getString("common.version_label") + "</strong> | " + locale.getString("common.vulnerability_tag") + "</p>");
        response.getWriter().println("<form method='get'>");
        response.getWriter().println("<p>" + locale.getString("dynamic.jar_url_label") + " <input type='text' name='url' placeholder='" + locale.getString("dynamic.jar_url_placeholder") + "' size='50' /></p>");
        response.getWriter().println("<p>" + locale.getString("dynamic.class_label") + " <input type='text' name='class' placeholder='" + locale.getString("dynamic.class_placeholder") + "' size='50' /></p>");
        response.getWriter().println("<p>" + locale.getString("dynamic.method_label") + " <input type='text' name='method' placeholder='" + locale.getString("dynamic.method_placeholder") + "' size='50' /></p>");
        response.getWriter().println("<input type='submit' value='" + locale.getString("dynamic.submit_button") + "' />");
        response.getWriter().println("</form>");
        
        if (classUrl != null && className != null && methodName != null) {
            try {
                // VULNERABLE: URLClassLoader with user-supplied URL
                // VULNERABLE: Allows loading arbitrary classes from remote sources
                URL[] urls = {new URL(classUrl)};
                URLClassLoader classLoader = new URLClassLoader(urls);
                
                // VULNERABLE: Loading class by user-supplied name
                Class<?> loadedClass = classLoader.loadClass(className);
                
                // VULNERABLE: Invoking method by user-supplied name
                Method method = loadedClass.getMethod(methodName);
                Object instance = loadedClass.getDeclaredConstructor().newInstance();
                Object result = method.invoke(instance);
                
                response.getWriter().println("<h2>" + locale.getString("dynamic.result_header") + "</h2>");
                response.getWriter().println("<pre>");
                response.getWriter().println(locale.getString("dynamic.class_loaded_label") + " " + loadedClass.getName());
                response.getWriter().println(locale.getString("dynamic.method_invoked_label") + " " + methodName);
                response.getWriter().println(locale.getString("dynamic.return_value_label") + " " + result);
                response.getWriter().println("</pre>");
                
            } catch (Exception e) {
                response.getWriter().println("<p>" + locale.getString("dynamic.error_message") + " " + e.getMessage() + "</p>");
                response.getWriter().println("<pre>");
                e.printStackTrace(response.getWriter());
                response.getWriter().println("</pre>");
            }
        }
        
        response.getWriter().println("</body></html>");
    }
}
