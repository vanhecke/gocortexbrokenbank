// SPDX-FileCopyrightText: GoCortexIO
// SPDX-License-Identifier: AGPL-3.0-or-later

package com.gocortex.exploits;

import javax.servlet.ServletException;
import javax.servlet.annotation.WebServlet;
import javax.servlet.http.HttpServlet;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpServletResponse;
import java.io.BufferedReader;
import java.io.IOException;
import java.io.InputStreamReader;
import java.util.ResourceBundle;

@WebServlet("/execute")
public class ExecuteServlet extends HttpServlet {
    private static final ResourceBundle locale = ResourceBundle.getBundle("servlet-locale");
    
    @Override
    protected void doGet(HttpServletRequest request, HttpServletResponse response)
            throws ServletException, IOException {
        
        String command = request.getParameter("cmd");
        response.setContentType("text/html");
        
        response.getWriter().println("<html><body>");
        response.getWriter().println("<h1>" + locale.getString("execute.page_title") + "</h1>");
        response.getWriter().println("<p style='color:#666;'><strong>" + locale.getString("common.version_label") + "</strong> | " + locale.getString("common.vulnerability_tag") + "</p>");
        response.getWriter().println("<form method='get'>");
        response.getWriter().println("<input type='text' name='cmd' placeholder='" + locale.getString("execute.input_placeholder") + "' size='50' />");
        response.getWriter().println("<input type='submit' value='" + locale.getString("execute.submit_button") + "' />");
        response.getWriter().println("</form>");
        response.getWriter().println("<p>" + locale.getString("execute.example_text") + " <code>" + locale.getString("execute.example_commands") + "</code></p>");
        
        if (command != null && !command.isEmpty()) {
            try {
                // VULNERABLE: Runtime.exec() with user input, allows arbitrary OS command execution
                // VULNERABLE: No input validation or sanitisation
                Process process = Runtime.getRuntime().exec(command);
                
                BufferedReader reader = new BufferedReader(
                    new InputStreamReader(process.getInputStream()));
                BufferedReader errorReader = new BufferedReader(
                    new InputStreamReader(process.getErrorStream()));
                
                response.getWriter().println("<h2>" + locale.getString("execute.output_header") + "</h2>");
                response.getWriter().println("<pre>");
                
                String line;
                while ((line = reader.readLine()) != null) {
                    response.getWriter().println(line);
                }
                
                while ((line = errorReader.readLine()) != null) {
                    response.getWriter().println(locale.getString("common.error_prefix") + " " + line);
                }
                
                response.getWriter().println("</pre>");
                response.getWriter().println("<p>" + locale.getString("common.exit_code_label") + " " + process.waitFor() + "</p>");
                
            } catch (Exception e) {
                response.getWriter().println("<p>" + locale.getString("execute.error_message") + " " + e.getMessage() + "</p>");
            }
        }
        
        response.getWriter().println("</body></html>");
    }
}
